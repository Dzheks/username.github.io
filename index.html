<script>
  // === SAFE TELEGRAM INIT ===
  const tg = window.Telegram?.WebApp || {
    expand: () => {},
    showAlert: (t) => alert(t)
  };
  tg.expand();

  // === PRODUCTS ===
  const products = [
    {id:1, cat:"PlayStation", name:"PS Plus Essential", price:499, img:"images/ps-essential.png"},
    {id:2, cat:"PlayStation", name:"PS Plus Extra", price:799, img:"images/ps-extra.png"},
    {id:3, cat:"PlayStation", name:"PS Plus Deluxe", price:1099, img:"images/ps-deluxe.png"},
    {id:4, cat:"Steam", name:"Steam Wallet 1000₽", price:1000, img:"images/steam-1000.png"},
    {id:5, cat:"Steam", name:"Steam Wallet 3000₽", price:3000, img:"images/steam-3000.png"},
    {id:6, cat:"Xbox", name:"Xbox Game Pass", price:899, img:"images/xbox-pass.png"}
  ];

  const catalog = document.getElementById("catalog");
  const cartItems = document.getElementById("cartItems");
  const totalEl = document.getElementById("total");
  const countEl = document.getElementById("count");

  let cart = [];

  // === CATALOG ===
  function renderCatalog(category = "all") {
    catalog.innerHTML = "";
    products
      .filter(p => category === "all" || p.cat === category)
      .forEach(p => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="${p.img}" onerror="this.src='https://via.placeholder.com/300x180?text=NovaShop'">
          <div class="card-content">
            <h3>${p.name}</h3>
            <div class="price">${p.price}₽</div>
            <button class="btn">Добавить</button>
          </div>
        `;
        card.querySelector("button").onclick = () => addToCart(p.id);
        catalog.appendChild(card);
      });
  }

  // === CART ===
  function addToCart(id) {
    cart.push(id);
    renderCart();
    tg.showAlert("✅ Товар добавлен");
  }

  function renderCart() {
    cartItems.innerHTML = "";
    let sum = 0;
    cart.forEach(id => {
      const p = products.find(x => x.id === id);
      sum += p.price;
      cartItems.innerHTML += `
        <div class="cart-item">
          <span>${p.name}</span>
          <span>${p.price}₽</span>
        </div>`;
    });
    totalEl.textContent = `Итого: ${sum}₽`;
    countEl.textContent = cart.length;
  }

  // === CATEGORIES ===
  document.querySelectorAll(".category-btn").forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      renderCatalog(btn.dataset.cat);
    };
  });

  // === NAVIGATION ===
  document.querySelectorAll(".nav button").forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      document.getElementById(btn.dataset.screen).classList.add("active");
    };
  });

  // === INIT ===
  renderCatalog();
</script>
